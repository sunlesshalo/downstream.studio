{% extends "base.html" %}

{% block title %}{{ stream.input.title if stream.input else stream.id }}{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="/streams" style="color: var(--accent); text-decoration: none;">← Back to Streams</a>
</div>

<div class="flex justify-between items-center" style="margin-bottom: 2rem;">
    <h1>{{ stream.input.title if stream.input else stream.id }}</h1>
    {% if stream.deployment %}
    <a href="{{ stream.deployment.url }}?ds_skip=1" class="btn btn-primary" target="_blank">View Live →</a>
    {% endif %}
</div>

<!-- Pipeline Status -->
<div class="card">
    <div class="card-header">Production Pipeline</div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.375rem; text-align: center;">
            <div class="text-sm text-muted mb-1">Story Input</div>
            <div class="text-lg">
                {% if stream.input %}✓{% else %}○{% endif %}
            </div>
            <a href="/streams/{{ stream.id }}/story" class="btn btn-sm btn-secondary mt-1">View</a>
        </div>

        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.375rem; text-align: center;">
            <div class="text-sm text-muted mb-1">Production Spec</div>
            <div class="text-lg">
                {% if stream.production %}✓{% else %}○{% endif %}
            </div>
            {% if stream.production %}
            <a href="/streams/{{ stream.id }}/spec" class="btn btn-sm btn-secondary mt-1">Edit</a>
            {% else %}
            <a href="/streams/{{ stream.id }}/spec/create" class="btn btn-sm btn-primary mt-1">Create</a>
            {% endif %}
        </div>

        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.375rem; text-align: center;">
            <div class="text-sm text-muted mb-1">Keyframes</div>
            <div class="text-lg">
                {% set keyframe_count = stream.path.joinpath('keyframes').glob('*.png') | list | length %}
                {% if keyframe_count > 0 %}{{ keyframe_count }}{% else %}○{% endif %}
            </div>
            {% if keyframe_count > 0 %}
            <a href="/streams/{{ stream.id }}/keyframes" class="btn btn-sm btn-secondary mt-1">Review</a>
            {% elif stream.production %}
            <button class="btn btn-sm btn-primary mt-1">Generate</button>
            {% endif %}
        </div>

        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.375rem; text-align: center;">
            <div class="text-sm text-muted mb-1">Videos</div>
            <div class="text-lg">
                {% set video_count = stream.path.joinpath('videos').glob('*.mp4') | list | length %}
                {% if video_count > 0 %}{{ video_count }}{% else %}○{% endif %}
            </div>
            {% if video_count > 0 %}
            <a href="/streams/{{ stream.id }}/videos" class="btn btn-sm btn-secondary mt-1">Review</a>
            {% elif keyframe_count > 0 %}
            <button class="btn btn-sm btn-primary mt-1">Generate</button>
            {% endif %}
        </div>

        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 0.375rem; text-align: center;">
            <div class="text-sm text-muted mb-1">Deployment</div>
            <div class="text-lg">
                {% if stream.deployment %}✓{% else %}○{% endif %}
            </div>
            {% if stream.deployment %}
            <a href="/streams/{{ stream.id }}/preview" class="btn btn-sm btn-secondary mt-1">Preview</a>
            {% elif video_count > 0 %}
            <button class="btn btn-sm btn-primary mt-1">Deploy</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Tasks -->
{% if tasks %}
<div class="card">
    <div class="card-header">Recent Tasks</div>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                    <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-weight: 500;">Type</th>
                    <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-weight: 500;">Segment</th>
                    <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-weight: 500;">Status</th>
                    <th style="text-align: left; padding: 0.75rem; color: var(--text-muted); font-weight: 500;">Created</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 0.75rem;">{{ task.task_type }}</td>
                    <td style="padding: 0.75rem;">
                        {% if task.segment_id %}#{{ task.segment_id }}{% else %}-{% endif %}
                    </td>
                    <td style="padding: 0.75rem;">
                        <span class="status status-{{ task.status }}">{{ task.status }}</span>
                    </td>
                    <td style="padding: 0.75rem; color: var(--text-muted); font-size: 0.875rem;">
                        {{ task.created_at }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="card">
    <div class="card-header">Quick Actions</div>
    <div class="flex gap-2">
        <a href="/streams/{{ stream.id }}/story" class="btn btn-secondary">Review Story</a>
        {% if stream.production %}
        <a href="/streams/{{ stream.id }}/spec" class="btn btn-secondary">Edit Spec</a>
        <a href="/streams/{{ stream.id }}/keyframes" class="btn btn-secondary">Review Keyframes</a>
        {% endif %}
    </div>
</div>
{% endblock %}
