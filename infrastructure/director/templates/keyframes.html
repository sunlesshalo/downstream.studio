{% extends "base.html" %}

{% block title %}Keyframes - {{ stream.input.title if stream.input else stream.id }}{% endblock %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="/streams/{{ stream.id }}" style="color: var(--accent); text-decoration: none;">← Back to {{ stream.input.title if stream.input else stream.id }}</a>
</div>

<div class="flex justify-between items-center" style="margin-bottom: 2rem;">
    <h1>Keyframe Review (Checkpoint 3)</h1>
    <div class="flex gap-1">
        <span class="text-sm text-muted">{{ keyframes | length }} keyframes</span>
    </div>
</div>

{% if not keyframes %}
<div class="card">
    <p class="text-muted">No keyframes generated yet.</p>
    <p class="mt-2">Keyframes will appear here after generation. Each keyframe is a static image that will be animated into video.</p>
</div>
{% else %}

<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
    {% for kf in keyframes %}
    <div class="card" style="padding: 0; overflow: hidden;" id="keyframe-{{ kf.segment_id }}">
        <div style="aspect-ratio: 1; background: var(--bg-primary); position: relative;">
            <img src="file://{{ kf.path }}"
                 alt="Segment {{ kf.segment_id }}"
                 style="width: 100%; height: 100%; object-fit: contain;">
        </div>

        <div style="padding: 1rem;">
            <div class="flex justify-between items-center mb-1">
                <h3 style="font-weight: 600; font-size: 0.875rem;">
                    Segment {{ kf.segment_id }}
                    {% if kf.segment and kf.segment.title %}: {{ kf.segment.title }}{% endif %}
                </h3>
                {% if kf.decision %}
                <span class="status status-sm
                    {% if kf.decision == 'approved' %}status-completed
                    {% elif kf.decision == 'regenerate' %}status-failed
                    {% else %}status-pending{% endif %}">
                    {{ kf.decision }}
                </span>
                {% else %}
                <span class="status status-pending">pending</span>
                {% endif %}
            </div>

            {% if kf.segment and kf.segment.image_prompt %}
            <p class="text-xs text-muted" style="margin-bottom: 0.75rem; line-height: 1.4; max-height: 4rem; overflow: hidden;">
                {{ kf.segment.image_prompt[:120] }}{% if kf.segment.image_prompt | length > 120 %}...{% endif %}
            </p>
            {% endif %}

            <div class="flex gap-1" id="actions-{{ kf.segment_id}}">
                <button class="btn btn-sm btn-success"
                        style="flex: 1;"
                        hx-post="/streams/{{ stream.id }}/approve/{{ kf.segment_id }}/keyframe"
                        hx-target="#keyframe-{{ kf.segment_id }}"
                        hx-swap="outerHTML"
                        {% if kf.decision == 'approved' %}disabled{% endif %}>
                    Approve
                </button>
                <button class="btn btn-sm btn-danger"
                        style="flex: 1;"
                        hx-post="/streams/{{ stream.id }}/regenerate/{{ kf.segment_id }}/keyframe"
                        hx-target="#actions-{{ kf.segment_id }}"
                        hx-swap="innerHTML">
                    Regenerate
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="flex gap-2 mt-2">
    <a href="/streams/{{ stream.id }}" class="btn btn-secondary">Back</a>
    <a href="/streams/{{ stream.id }}/videos" class="btn btn-primary">Review Videos →</a>
</div>

{% endif %}
{% endblock %}
