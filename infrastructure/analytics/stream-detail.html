<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0a0f;
      --bg-card: #141419;
      --bg-hover: #1a1a22;
      --text: #e5e5e5;
      --text-muted: #888;
      --accent: #d4a056;
      --success: #4ade80;
      --info: #60a5fa;
      --warning: #fbbf24;
      --border: #2a2a35;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    header {
      margin-bottom: 32px;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .back-link:hover {
      color: var(--text);
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 16px;
    }

    .stream-header {
      flex: 1;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .stream-meta {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .stream-id {
      font-family: monospace;
      font-size: 13px;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .stream-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 14px;
    }

    .stream-link:hover {
      text-decoration: underline;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .period-select {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .period-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .period-btn:hover {
      color: var(--text);
    }

    .period-btn.active {
      background: var(--accent);
      color: var(--bg);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }

    .chart-card.span-8 { grid-column: span 8; }
    .chart-card.span-6 { grid-column: span 6; }
    .chart-card.span-4 { grid-column: span 4; }
    .chart-card.span-12 { grid-column: span 12; }

    @media (max-width: 1024px) {
      .chart-card.span-8,
      .chart-card.span-6,
      .chart-card.span-4 {
        grid-column: span 12;
      }
    }

    .chart-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 16px;
    }

    .chart-container {
      position: relative;
      height: 220px;
    }

    .chart-container.tall {
      height: 300px;
    }

    /* Funnel styles */
    .funnel-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .funnel-step {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .funnel-label {
      width: 50px;
      font-size: 13px;
      color: var(--text-muted);
      text-align: right;
    }

    .funnel-bar-container {
      flex: 1;
      height: 32px;
      background: var(--bg-hover);
      border-radius: 4px;
      overflow: hidden;
    }

    .funnel-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--warning));
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      min-width: 40px;
      transition: width 0.5s ease;
    }

    .funnel-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--bg);
    }

    .funnel-count {
      width: 60px;
      font-size: 13px;
      color: var(--text-muted);
      text-align: left;
    }

    /* List styles */
    .list-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 280px;
      overflow-y: auto;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-name {
      font-size: 14px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 200px;
    }

    .list-count {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
    }

    /* Section bars */
    .section-bars {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-label {
      width: 100px;
      font-size: 13px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .section-bar-bg {
      flex: 1;
      height: 24px;
      background: var(--bg-hover);
      border-radius: 4px;
      overflow: hidden;
    }

    .section-bar-fill {
      height: 100%;
      background: var(--info);
      border-radius: 4px;
      display: flex;
      align-items: center;
      padding-left: 8px;
      min-width: 30px;
    }

    .section-bar-value {
      font-size: 11px;
      font-weight: 600;
      color: white;
    }

    .stat-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Mode distribution */
    .mode-container {
      padding: 8px 0;
    }

    .mode-bar-container {
      display: flex;
      height: 48px;
      background: var(--bg-hover);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .mode-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: width 0.5s ease;
      min-width: 60px;
    }

    .mode-bar.reading-bar {
      background: linear-gradient(90deg, #60a5fa, #3b82f6);
    }

    .mode-bar.watching-bar {
      background: linear-gradient(90deg, #d4a056, #f59e0b);
    }

    .mode-label {
      font-size: 12px;
      font-weight: 500;
      color: white;
    }

    .mode-value {
      font-size: 14px;
      font-weight: 700;
      color: white;
    }

    .mode-legend {
      display: flex;
      gap: 24px;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.reading {
      background: #60a5fa;
    }

    .legend-dot.watching {
      background: #d4a056;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .empty {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 12px;
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/dashboard" class="back-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back to Dashboard
      </a>
      <div class="header-row">
        <div class="stream-header">
          <h1 id="stream-title">Loading...</h1>
          <div class="stream-meta">
            <span class="stream-id" id="stream-id"></span>
            <a href="#" class="stream-link" id="stream-url" target="_blank">View Stream</a>
          </div>
        </div>
        <div class="header-controls">
          <div class="period-select">
            <button class="period-btn" data-days="1">24h</button>
            <button class="period-btn active" data-days="7">7d</button>
            <button class="period-btn" data-days="30">30d</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Key Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="total-views">-</div>
        <div class="stat-label">Total Views</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="unique-visitors">-</div>
        <div class="stat-label">Unique Visitors</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="completion-rate">-</div>
        <div class="stat-label">Completion Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avg-time">-</div>
        <div class="stat-label">Avg Active Time</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="avg-depth">-</div>
        <div class="stat-label">Avg Scroll Depth</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="reading-ratio">-</div>
        <div class="stat-label">Reading Ratio</div>
        <div class="stat-hint" id="reading-ratio-hint"></div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="scroll-intensity">-</div>
        <div class="stat-label">Scroll Intensity</div>
        <div class="stat-hint" id="scroll-intensity-hint"></div>
      </div>
    </div>

    <!-- Mode Distribution -->
    <div class="charts-grid">
      <div class="chart-card span-12" id="mode-card" style="display: none;">
        <div class="chart-title">Engagement Mode Distribution</div>
        <div class="mode-container">
          <div class="mode-bar-container">
            <div class="mode-bar reading-bar" id="reading-bar" style="width: 0%">
              <span class="mode-label">Reading</span>
              <span class="mode-value" id="reading-pct">-</span>
            </div>
            <div class="mode-bar watching-bar" id="watching-bar" style="width: 0%">
              <span class="mode-label">Watching</span>
              <span class="mode-value" id="watching-pct">-</span>
            </div>
          </div>
          <div class="mode-legend">
            <span class="legend-item"><span class="legend-dot reading"></span> Reading (slow scroll, &lt;30 px/sec)</span>
            <span class="legend-item"><span class="legend-dot watching"></span> Watching (fast scroll, &gt;50 px/sec)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 1: Views + Devices -->
    <div class="charts-grid">
      <div class="chart-card span-8">
        <div class="chart-title">Views Over Time</div>
        <div class="chart-container tall">
          <canvas id="views-chart"></canvas>
        </div>
      </div>
      <div class="chart-card span-4">
        <div class="chart-title">Devices</div>
        <div class="chart-container tall">
          <canvas id="devices-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Row 2: Funnel + Hours -->
    <div class="charts-grid">
      <div class="chart-card span-6">
        <div class="chart-title">Scroll Depth Funnel</div>
        <div class="funnel-container" id="funnel-container">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="chart-card span-6">
        <div class="chart-title">Peak Hours (UTC)</div>
        <div class="chart-container">
          <canvas id="hours-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Row 3: Sections -->
    <div class="charts-grid">
      <div class="chart-card span-12">
        <div class="chart-title">Section Engagement (Avg Dwell Time)</div>
        <div class="section-bars" id="sections-container">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <!-- Row 4: Referrers + Geography -->
    <div class="charts-grid">
      <div class="chart-card span-6">
        <div class="chart-title">Top Referrers</div>
        <div class="list-container" id="referrers-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
      <div class="chart-card span-6">
        <div class="chart-title">Top Countries</div>
        <div class="list-container" id="countries-list">
          <div class="loading">Loading...</div>
        </div>
      </div>
    </div>

    <footer>
      <span>Last updated: <span id="last-updated">-</span></span>
      <span>DownStream Analytics</span>
    </footer>
  </div>

  <script>
    // Get stream ID from URL
    const pathParts = window.location.pathname.split('/');
    const streamId = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

    let currentDays = 7;
    let charts = {};

    // Chart.js defaults
    Chart.defaults.color = '#888';
    Chart.defaults.borderColor = '#2a2a35';
    Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";

    // Period buttons
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDays = parseInt(btn.dataset.days);
        loadAll();
      });
    });

    async function loadStreamInfo() {
      try {
        const res = await fetch(`/stream/${streamId}/info`);
        const data = await res.json();

        document.getElementById('stream-title').textContent = data.title || streamId;
        document.getElementById('stream-id').textContent = data.id || streamId;

        const urlEl = document.getElementById('stream-url');
        if (data.deployment_url) {
          urlEl.href = data.deployment_url;
          urlEl.style.display = 'inline';
        } else {
          urlEl.style.display = 'none';
        }

        document.title = `${data.title || streamId} - Analytics`;
      } catch (e) {
        console.error('Stream info error:', e);
        document.getElementById('stream-title').textContent = streamId;
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(`/stats/${streamId}?days=${currentDays}`);
        const data = await res.json();

        document.getElementById('total-views').textContent = formatNumber(data.total_views);
        document.getElementById('unique-visitors').textContent = formatNumber(data.unique_visitors);
        document.getElementById('completion-rate').textContent = data.completion_rate + '%';
        document.getElementById('avg-depth').textContent = Math.round(data.avg_scroll_depth) + '%';

        const avgTime = data.avg_time_seconds || 0;
        const mins = Math.floor(avgTime / 60);
        const secs = Math.round(avgTime % 60);
        document.getElementById('avg-time').textContent = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;

        // Phase 1 metrics
        const p1 = data.phase1_metrics || {};

        // Reading ratio
        if (p1.reading_ratio !== null && p1.reading_ratio !== undefined) {
          document.getElementById('reading-ratio').textContent = p1.reading_ratio + 'x';
          const hint = p1.reading_ratio >= 1
            ? 'Time to read all content'
            : 'Read ' + Math.round(p1.reading_ratio * 100) + '% of content';
          document.getElementById('reading-ratio-hint').textContent = hint;
        } else {
          document.getElementById('reading-ratio').textContent = '-';
          document.getElementById('reading-ratio-hint').textContent = p1.has_metadata ? 'No data yet' : 'No metadata';
        }

        // Scroll intensity
        if (p1.scroll_intensity !== null && p1.scroll_intensity !== undefined) {
          document.getElementById('scroll-intensity').textContent = p1.scroll_intensity + 'x';
          const hint = p1.scroll_intensity > 1
            ? 'Replayed content'
            : 'Scrolled ' + Math.round(p1.scroll_intensity * 100) + '% of content';
          document.getElementById('scroll-intensity-hint').textContent = hint;
        } else {
          document.getElementById('scroll-intensity').textContent = '-';
          document.getElementById('scroll-intensity-hint').textContent = p1.has_metadata ? 'No data yet' : 'No metadata';
        }

        // Mode distribution
        const mode = p1.mode_distribution || {};
        if (mode.reading_pct !== null && mode.watching_pct !== null) {
          document.getElementById('mode-card').style.display = 'block';
          document.getElementById('reading-bar').style.width = mode.reading_pct + '%';
          document.getElementById('watching-bar').style.width = mode.watching_pct + '%';
          document.getElementById('reading-pct').textContent = mode.reading_pct + '%';
          document.getElementById('watching-pct').textContent = mode.watching_pct + '%';
        } else {
          document.getElementById('mode-card').style.display = 'none';
        }
      } catch (e) {
        console.error('Stats error:', e);
      }
    }

    async function loadViewsChart() {
      try {
        const res = await fetch(`/stream/${streamId}/daily-views?days=${currentDays}`);
        const data = await res.json();

        const ctx = document.getElementById('views-chart').getContext('2d');
        if (charts.views) charts.views.destroy();

        charts.views = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.daily.map(d => formatDate(d.date)),
            datasets: [
              {
                label: 'Views',
                data: data.daily.map(d => d.views),
                borderColor: '#d4a056',
                backgroundColor: 'rgba(212, 160, 86, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4
              },
              {
                label: 'Unique',
                data: data.daily.map(d => d.unique_visitors),
                borderColor: '#60a5fa',
                backgroundColor: 'rgba(96, 165, 250, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', align: 'end' } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#2a2a35' } },
              x: { grid: { display: false } }
            }
          }
        });
      } catch (e) {
        console.error('Views chart error:', e);
      }
    }

    async function loadDevicesChart() {
      try {
        const res = await fetch(`/stream/${streamId}/devices?days=${currentDays}`);
        const data = await res.json();

        const ctx = document.getElementById('devices-chart').getContext('2d');
        if (charts.devices) charts.devices.destroy();

        const colors = { 'mobile': '#d4a056', 'desktop': '#60a5fa', 'tablet': '#4ade80', 'unknown': '#888' };

        charts.devices = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: data.devices.map(d => capitalize(d.device)),
            datasets: [{
              data: data.devices.map(d => d.count),
              backgroundColor: data.devices.map(d => colors[d.device] || '#888'),
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '65%',
            plugins: { legend: { position: 'bottom' } }
          }
        });
      } catch (e) {
        console.error('Devices chart error:', e);
      }
    }

    async function loadScrollFunnel() {
      try {
        const res = await fetch(`/stream/${streamId}/scroll-funnel?days=${currentDays}`);
        const data = await res.json();

        const container = document.getElementById('funnel-container');
        const total = data.total_views || 1;
        const milestones = data.milestones;

        const steps = [
          { label: 'Start', value: total, pct: 100 },
          { label: '25%', value: milestones['25'] || 0, pct: Math.round((milestones['25'] || 0) / total * 100) },
          { label: '50%', value: milestones['50'] || 0, pct: Math.round((milestones['50'] || 0) / total * 100) },
          { label: '75%', value: milestones['75'] || 0, pct: Math.round((milestones['75'] || 0) / total * 100) },
          { label: '100%', value: milestones['100'] || 0, pct: Math.round((milestones['100'] || 0) / total * 100) }
        ];

        container.innerHTML = steps.map(step => `
          <div class="funnel-step">
            <div class="funnel-label">${step.label}</div>
            <div class="funnel-bar-container">
              <div class="funnel-bar" style="width: ${step.pct}%">
                <span class="funnel-value">${step.pct}%</span>
              </div>
            </div>
            <div class="funnel-count">${formatNumber(step.value)}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Funnel error:', e);
      }
    }

    async function loadPeakHours() {
      try {
        const res = await fetch(`/stream/${streamId}/peak-hours?days=${currentDays}`);
        const data = await res.json();

        const ctx = document.getElementById('hours-chart').getContext('2d');
        if (charts.hours) charts.hours.destroy();

        charts.hours = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
              data: data.hourly,
              backgroundColor: 'rgba(212, 160, 86, 0.6)',
              borderRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true, grid: { color: '#2a2a35' } },
              x: { grid: { display: false }, ticks: { maxTicksLimit: 12 } }
            }
          }
        });
      } catch (e) {
        console.error('Hours chart error:', e);
      }
    }

    async function loadSections() {
      try {
        const res = await fetch(`/stream/${streamId}/sections?days=${currentDays}`);
        const data = await res.json();

        const container = document.getElementById('sections-container');

        if (!data.sections || data.sections.length === 0) {
          container.innerHTML = '<div class="empty">No section data</div>';
          return;
        }

        const maxDwell = Math.max(...data.sections.map(s => s.avg_dwell_ms || 0));

        container.innerHTML = data.sections.map(s => {
          const dwellSec = Math.round((s.avg_dwell_ms || 0) / 1000);
          const pct = maxDwell > 0 ? Math.round((s.avg_dwell_ms || 0) / maxDwell * 100) : 0;
          return `
            <div class="section-bar-item">
              <div class="section-label">${s.section_id || `Section ${s.section_index + 1}`}</div>
              <div class="section-bar-bg">
                <div class="section-bar-fill" style="width: ${Math.max(pct, 5)}%">
                  <span class="section-bar-value">${dwellSec}s</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Sections error:', e);
      }
    }

    async function loadReferrers() {
      try {
        const res = await fetch(`/stream/${streamId}/referrers?days=${currentDays}`);
        const data = await res.json();

        const container = document.getElementById('referrers-list');

        if (!data.referrers || data.referrers.length === 0) {
          container.innerHTML = '<div class="empty">No referrer data</div>';
          return;
        }

        container.innerHTML = data.referrers.map(r => `
          <div class="list-item">
            <span class="list-name" title="${escapeHtml(r.referrer)}">${escapeHtml(r.referrer)}</span>
            <span class="list-count">${formatNumber(r.count)}</span>
          </div>
        `).join('');
      } catch (e) {
        console.error('Referrers error:', e);
      }
    }

    async function loadGeography() {
      try {
        const res = await fetch(`/stream/${streamId}/geography?days=${currentDays}`);
        const data = await res.json();

        const container = document.getElementById('countries-list');

        if (!data.countries || data.countries.length === 0) {
          container.innerHTML = '<div class="empty">No data</div>';
          return;
        }

        container.innerHTML = data.countries.map(c => `
          <div class="list-item">
            <span class="list-name">${getCountryFlag(c.country)} ${c.country}</span>
            <span class="list-count">${formatNumber(c.count)}</span>
          </div>
        `).join('');
      } catch (e) {
        console.error('Geography error:', e);
      }
    }

    function loadAll() {
      document.getElementById('last-updated').textContent = 'Loading...';

      Promise.all([
        loadStats(),
        loadViewsChart(),
        loadDevicesChart(),
        loadScrollFunnel(),
        loadPeakHours(),
        loadSections(),
        loadReferrers(),
        loadGeography()
      ]).then(() => {
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
      });
    }

    function formatNumber(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return (n || 0).toString();
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function capitalize(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, char => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[char]);
    }

    function getCountryFlag(code) {
      if (!code || code === 'Unknown') return '';
      const codePoints = code.toUpperCase().split('').map(char => 127397 + char.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    }

    // Initial load
    loadStreamInfo();
    loadAll();

    // Auto-refresh every 60 seconds
    setInterval(loadAll, 60000);
  </script>
</body>
</html>
